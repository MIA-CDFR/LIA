<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Quem Quer Ser Milionário</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: radial-gradient(circle at top, #0b1a3a, #000);
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 12px;
      padding: 20px 30px 30px;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
    }
    h1 { margin-top: 0; letter-spacing: 2px; }
    .status-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-size: 0.95rem;
    }
    .timer {
      font-weight: bold;
    }
    .question { font-size: 1.2rem; margin: 20px 0; min-height: 60px; }
    .options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    .option-btn {
      border: 1px solid #555;
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
      background: #112244;
      color: #fff;
      font-size: 0.95rem;
      text-align: left;
    }
    .option-btn:hover { background: #16305e; }
    .option-btn.correct { background: #1f7a1f; border-color: #4caf50; }
    .option-btn.wrong   { background: #7a1f1f; border-color: #f44336; }
    .lifelines {
      margin: 10px 0 15px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    .lifeline-btn {
      border-radius: 20px;
      border: 1px solid #ffc107;
      background: #333;
      color: #ffc107;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .lifeline-btn.used {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .controls { margin-top: 10px; }
    .quit-btn {
      border-radius: 20px;
      border: 1px solid #f44336;
      background: #330000;
      color: #f44336;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .next-btn {
      margin-top: 10px;
      border-radius: 20px;
      border: 1px solid #4caf50;
      background: #003300;
      color: #4caf50;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .message { margin-top: 10px; min-height: 24px; font-size: 0.95rem; }
    .public-help { margin-top: 10px; font-size: 0.85rem; white-space: pre-line; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Quem Quer Ser Milionário</h1>

    <div class="status-bar">
      <div id="questionNumber"></div>
      <div>
        Saldo: <span id="saldo">€0</span> |
        Patamar: <span id="patamar">€0</span> |
        <span class="timer">Tempo: <span id="timer">30</span>s</span>
      </div>
    </div>

    <div class="question" id="questionText"></div>
    <div class="options" id="optionsContainer"></div>

    <div class="lifelines">
      <button class="lifeline-btn" id="btn5050">50/50</button>
      <button class="lifeline-btn" id="btnPublico">Ajuda do Público</button>
      <button class="lifeline-btn" id="btnTelefone">Telefone</button>
    </div>

    <div class="controls">
      <button class="quit-btn" id="btnDesistir">Desistir</button>
      <button class="next-btn" id="btnProxima" style="display:none;">Próxima pergunta</button>
    </div>

    <div class="message" id="message"></div>
    <div class="public-help" id="publicHelp"></div>

    <div style="margin-top:15px;font-size:0.8rem;opacity:0.7;">
      Frontend em JavaScript + Backend em Prolog (SWI-Prolog).
    </div>
  </div>

  <!-- Sons (tens de ter acerto.mp3 e erro.mp3 na mesma pasta) -->
  <audio id="soundAcerto" src="./sons/correct.mp3"></audio>
  <audio id="soundErro"   src="./sons/error.mp3"></audio>
  <audio id="soundBegin" src="./sons/begin.mp3"></audio>
  <audio id="soundQuestion" src="./sons/question.mp3"></audio>

  <script>
    // API na mesma origem: http://localhost:8086/api/...
    const API_BASE = 'http://localhost:8086/api';
    const TEMPO_POR_PERGUNTA = 30; // segundos

    let saldo = 0;
    let patamar = 0;
    let questionIndex = 0;
    let usedIds = [];
    let currentQuestion = null;
    let jogoTerminado = false;

    let timerValue = TEMPO_POR_PERGUNTA;
    let timerInterval = null;
    let questionActive = false;

    const safetyTiers = [
      { questionIndex: 5, amount: 1000 },
      { questionIndex: 10, amount: 5000 }
    ];

    const elQuestionNumber = document.getElementById('questionNumber');
    const elSaldo = document.getElementById('saldo');
    const elPatamar = document.getElementById('patamar');
    const elQuestionText = document.getElementById('questionText');
    const elOptionsContainer = document.getElementById('optionsContainer');
    const elMessage = document.getElementById('message');
    const elPublicHelp = document.getElementById('publicHelp');
    const elTimer = document.getElementById('timer');
    const btn5050 = document.getElementById('btn5050');
    const btnPublico = document.getElementById('btnPublico');
    const btnTelefone = document.getElementById('btnTelefone');
    const btnDesistir = document.getElementById('btnDesistir');
    const btnProxima = document.getElementById('btnProxima');

    const soundAcerto = document.getElementById('soundAcerto');
    const soundErro   = document.getElementById('soundErro');
    const soundBegin   = document.getElementById('soundBegin');
    const soundQuestion   = document.getElementById('soundQuestion');

    let lifelines = {
      '5050': false,
      publico: false,
      telefone: false
    };

    function resetTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerValue = TEMPO_POR_PERGUNTA;
      elTimer.textContent = timerValue;
      questionActive = true;

      timerInterval = setInterval(() => {
        if (!questionActive) return;
        timerValue--;
        elTimer.textContent = timerValue;
        if (timerValue <= 0) {
          clearInterval(timerInterval);
          questionActive = false;
          tempoEsgotado();
        }
      }, 1000);
    }

    async function tempoEsgotado() {
      if (!currentQuestion || jogoTerminado) return;
      elMessage.textContent = 'Tempo esgotado! A tratar como resposta errada...';
      bloquearOpcoes();

      try {
        const res = await fetch(`${API_BASE}/check?id=${currentQuestion.id}&answer=x`); // resposta inválida -> errada
        const data = await res.json();

        const correctLetter = data.correctLetter;
        const btns = elOptionsContainer.querySelectorAll('.option-btn');
        btns.forEach(b => {
          if (b.dataset.letra === correctLetter) b.classList.add('correct');
        });

        soundErro.currentTime = 0;
        soundErro.play();
        elMessage.textContent = `Tempo esgotado. Termina com o patamar de €${patamar}.`;
        jogoTerminado = true;
      } catch (err) {
        console.error(err);
        elMessage.textContent = 'Erro ao comunicar com o servidor Prolog.';
      }
    }

    async function fetchQuestion() {
      if (jogoTerminado) return;
      elMessage.textContent = 'A obter pergunta do Prolog...';
      elPublicHelp.textContent = '';
      btnProxima.style.display = 'none';

      soundQuestion.currentTime = 0;
      soundQuestion.play();

      try {
        const usedStr = usedIds.join(',');
        const res = await fetch(`${API_BASE}/question?used=${encodeURIComponent(usedStr)}`);
        const data = await res.json();

        if (data.done) {
          elMessage.textContent = `Fim das perguntas! Terminou com saldo de €${saldo}.`;
          jogoTerminado = true;
          return;
        }

        currentQuestion = data;
        usedIds.push(data.id);
        questionIndex++;

        renderQuestion();
        elMessage.textContent = '';
        resetTimer();
      } catch (err) {
        console.error(err);
        elMessage.textContent = 'Erro ao comunicar com o servidor Prolog.';
      }
    }

    function renderQuestion() {
      elQuestionNumber.textContent =
        `Pergunta ${questionIndex} (nível ${currentQuestion.level}, valendo €${currentQuestion.value})`;
      elQuestionText.textContent = currentQuestion.text;
      elOptionsContainer.innerHTML = '';
      elPublicHelp.textContent = '';

      ['a','b','c','d'].forEach(letra => {
        const texto = currentQuestion.options[letra];
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.dataset.letra = letra;
        btn.textContent = `(${letra.toUpperCase()}) ${texto}`;
        btn.addEventListener('click', () => responder(letra));
        elOptionsContainer.appendChild(btn);
      });
    }

    function updateStatus() {
      elSaldo.textContent = `€${saldo}`;
      elPatamar.textContent = `€${patamar}`;
    }

    function aplicarPatamar() {
      safetyTiers.forEach(tier => {
        if (questionIndex === tier.questionIndex && saldo >= tier.amount) {
          patamar = tier.amount;
        }
      });
    }

    function bloquearOpcoes() {
      elOptionsContainer.querySelectorAll('.option-btn')
        .forEach(b => b.disabled = true);
    }

    function desbloquearOpcoes() {
      elOptionsContainer.querySelectorAll('.option-btn')
        .forEach(b => {
          b.disabled = false;
          b.classList.remove('correct', 'wrong');
          b.style.visibility = 'visible';
        });
    }

    async function responder(letra) {
      if (!currentQuestion || jogoTerminado || !questionActive) return;
      questionActive = false;
      if (timerInterval) clearInterval(timerInterval);

      bloquearOpcoes();
      elMessage.textContent = 'A verificar resposta no Prolog...';

      try {
        const res = await fetch(`${API_BASE}/check?id=${currentQuestion.id}&answer=${letra}`);
        const data = await res.json();

        const correct = data.correct;
        const correctLetter = data.correctLetter;
        const valor = data.value;

        const btns = elOptionsContainer.querySelectorAll('.option-btn');
        btns.forEach(b => {
          if (b.dataset.letra === correctLetter) b.classList.add('correct');
          if (b.dataset.letra === letra && letra !== correctLetter) b.classList.add('wrong');
        });

        if (correct) {
          saldo += valor;
          aplicarPatamar();
          updateStatus();
          elMessage.textContent = `Resposta correta! +€${valor}.`;
          soundAcerto.currentTime = 0;
          soundAcerto.play();
          btnProxima.style.display = 'inline-block';
        } else {
          soundErro.currentTime = 0;
          soundErro.play();
          elMessage.textContent = `Resposta errada. Termina com o patamar de €${patamar}.`;
          jogoTerminado = true;
        }
      } catch (err) {
        console.error(err);
        elMessage.textContent = 'Erro ao verificar resposta no Prolog.';
      }
    }

    // Ajudas (simples do lado do JS)
    btn5050.addEventListener('click', () => {
      if (lifelines['5050'] || !currentQuestion || jogoTerminado) return;
      lifelines['5050'] = true;
      btn5050.classList.add('used');

      const correct = currentQuestion.correct;
      const letters = ['a','b','c','d'];
      const wrongs = letters.filter(l => l !== correct);
      shuffleArray(wrongs);
      const hide = wrongs.slice(0,2);

      elOptionsContainer.querySelectorAll('.option-btn').forEach(b => {
        if (hide.includes(b.dataset.letra)) {
          b.style.visibility = 'hidden';
        }
      });
    });

    btnPublico.addEventListener('click', () => {
      if (lifelines.publico || !currentQuestion || jogoTerminado) return;
      lifelines.publico = true;
      btnPublico.classList.add('used');

      const correct = currentQuestion.correct;
      const letters = ['a','b','c','d'];
      const correctPercent = randInt(50,80);
      const restante = 100 - correctPercent;
      const base = Math.floor(restante / 3);

      let texto = 'Ajuda do Público:\n';
      letters.forEach(l => {
        const p = (l === correct) ? correctPercent : base;
        texto += `Opção ${l.toUpperCase()}: ${p}%\n`;
      });
      elPublicHelp.textContent = texto;
    });

    btnTelefone.addEventListener('click', () => {
      if (lifelines.telefone || !currentQuestion || jogoTerminado) return;
      lifelines.telefone = true;
      btnTelefone.classList.add('used');

      const correct = currentQuestion.correct;
      const letters = ['a','b','c','d'];
      let sugerida;
      if (Math.random() <= 0.8) {
        sugerida = correct;
      } else {
        const wrongs = letters.filter(l => l !== correct);
        sugerida = wrongs[randInt(0, wrongs.length - 1)];
      }
      elPublicHelp.textContent =
        `Telefone:\n"Eu diria que a resposta certa é ${sugerida.toUpperCase()}, mas não tenho a certeza..."`;
    });

    btnDesistir.addEventListener('click', () => {
      if (jogoTerminado) return;
      jogoTerminado = true;
      questionActive = false;
      if (timerInterval) clearInterval(timerInterval);
      bloquearOpcoes();
      elMessage.textContent = `Desistiu com €${saldo}. Obrigado por jogar!`;
    });

    btnProxima.addEventListener('click', () => {
      if (jogoTerminado) return;
      desbloquearOpcoes();
      btnProxima.style.display = 'none';
      fetchQuestion();
    });

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }



    // iniciar
    

    updateStatus();
    fetchQuestion();



  </script>
</body>
</html>
